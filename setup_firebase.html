<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Configura√ß√£o Firebase KLYX</title>
    <link rel="stylesheet" href="./css/global.css" />
    <style>
        body { background: #111; color: #fff; font-family: sans-serif; padding: 20px; }
        button { padding: 10px 20px; cursor: pointer; background: #e50914; color: white; border: none; border-radius: 4px; font-size: 16px; margin-right: 10px; }
        button.secondary { background: #333; }
        #log { margin-top: 20px; white-space: pre-wrap; background: #222; padding: 10px; border-radius: 4px; font-family: monospace; min-height: 200px; }
        .warning { color: #ffcc00; margin-bottom: 20px; border: 1px solid #ffcc00; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>
        <img src="./assets/logos/logo.svg" alt="KLYX" style="height: 40px; vertical-align: middle;">
        <span class="connection-dot" id="connectionStatusDot" title="Checking connection..."></span>
        Configura√ß√£o Inicial do Banco de Dados
    </h1>
    
    <div class="warning">
        <strong>Aten√ß√£o:</strong> Certifique-se de que as Regras de Seguran√ßa (Rules) do seu Firebase Realtime Database est√£o configuradas como <code>".read": true, ".write": true</code> para permitir esta configura√ß√£o inicial. Depois voc√™ pode restringir.
    </div>

    <p>Use este utilit√°rio para enviar os dados locais (arquivos JSON) para o seu Firebase Realtime Database.</p>
    <p><strong>URL do Banco:</strong> https://klix-iptv-default-rtdb.firebaseio.com/</p>
    
    <button onclick="startMigration()">1. Enviar Cat√°logo Local para Firebase</button>
    <button class="secondary" onclick="checkConnection()">2. Testar Conex√£o</button>
    <button class="secondary" onclick="createAdminUser()">3. Criar Usu√°rio Admin de Teste</button>
    
    <div id="log">Log de opera√ß√µes aparecer√° aqui...</div>

    <script>
        const FIREBASE_URL = "https://klix-iptv-default-rtdb.firebaseio.com";
        const logEl = document.getElementById('log');

        function log(msg) {
            logEl.textContent += '\n' + msg;
            console.log(msg);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function checkConnection() {
            log("Testando conex√£o com Firebase...");
            const connectionDot = document.getElementById("connectionStatusDot");
            try {
                const res = await fetch(`${FIREBASE_URL}/.json?shallow=true`);
                if (res.ok) {
                    log("‚úÖ Conex√£o BEM-SUCEDIDA! O banco est√° acess√≠vel.");
                    if(connectionDot) {
                        connectionDot.classList.add("connected");
                        connectionDot.title = "Connected";
                    }
                } else {
                    log(`‚ùå Erro de conex√£o: ${res.status} ${res.statusText}. Verifique as Regras de Seguran√ßa.`);
                    if(connectionDot) connectionDot.classList.remove("connected");
                }
            } catch (e) {
                log(`‚ùå Erro de rede: ${e.message}`);
                if(connectionDot) connectionDot.classList.remove("connected");
            }
        }

        // Auto check on load
        checkConnection();

        async function uploadFile(localPath, firebasePath) {
            log(`üìÇ Lendo arquivo local: ${localPath}...`);
            try {
                const res = await fetch(localPath);
                if (!res.ok) throw new Error(`Arquivo n√£o encontrado: ${localPath}`);
                const data = await res.json();
                
                log(`‚òÅÔ∏è Enviando para Firebase: /${firebasePath}...`);
                const fbRes = await fetch(`${FIREBASE_URL}/${firebasePath}.json`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                if (fbRes.ok) log(`‚úÖ Sucesso: ${firebasePath} atualizado!`);
                else log(`‚ùå Erro Firebase: ${fbRes.status} ${fbRes.statusText}`);
                
            } catch (e) {
                log(`‚ùå Falha: ${e.message}`);
            }
        }

        async function startMigration() {
            logEl.textContent = "üöÄ Iniciando migra√ß√£o de dados...\n";
            
            await uploadFile('./assets/data/home.json', 'catalog/home');
            await uploadFile('./assets/data/movies.json', 'catalog/movies');
            await uploadFile('./assets/data/series.json', 'catalog/series');
            await uploadFile('./assets/data/episodes.json', 'catalog/episodes');
            await uploadFile('./assets/data/live.json', 'catalog/live');
            
            log("\nüèÅ Processo finalizado! Se todos os passos deram ‚úÖ, o app agora vai ler esses dados do Firebase.");
        }

        async function createAdminUser() {
            const email = "admin@klyx.app";
            // Substituindo . por , e @ por _at_ conforme l√≥gica do api.js
            const emailKey = email.replace(/\./g, ',').replace(/@/g, '_at_');
            const password = "admin";
            
            log(`Creating test user: ${email} / ${password}`);
            
            const user = {
                id: emailKey,
                email: email,
                password: password,
                display_name: "Admin User",
                created_at: new Date().toISOString(),
                profiles: {
                    p1: { id: "p1", name: "Admin", avatar: "avatar1.png", is_kid: false }
                }
            };

            try {
                const res = await fetch(`${FIREBASE_URL}/users/${emailKey}.json`, {
                    method: 'PUT',
                    body: JSON.stringify(user)
                });
                if (res.ok) log("‚úÖ Usu√°rio criado com sucesso!");
                else log("‚ùå Erro ao criar usu√°rio.");
            } catch(e) {
                log(`‚ùå Erro: ${e.message}`);
            }
        }
    </script>
</body>
</html>
